<ion-header>
  <ion-toolbar color="primary">
    <ion-grid>
      <ion-row>
        <ion-col class="ion-text-center">
          <ion-button fill="clear" color="light" [routerLink]="['/home']">
            Inicio
          </ion-button>
        </ion-col>

        <ion-col class="ion-text-center">
          <ion-button fill="clear" color="light" [routerLink]="['/community']">
            Comunidad
          </ion-button>
        </ion-col>

        <ion-col class="ion-text-center">
          <!-- Muestra "Perfil" o "Iniciar Sesión" -->
          <ion-button fill="clear" color="light" (click)="onProfileButtonClick($event)">
            {{ isLoggedIn ? 'Perfil' : 'Iniciar Sesión' }}
          </ion-button>
        </ion-col>
      </ion-row>
    </ion-grid>
  </ion-toolbar>
</ion-header>

<!-- Overlay desenfoque -->
<div class="backdrop-blur" *ngIf="showPopover" (click)="showPopover=false"></div>


<!-- Menú desplegable -->
<ion-popover [isOpen]="showPopover" (didDismiss)="showPopover = false" [event]="popoverEvent">
  <ng-template>
    <ion-content>
      <ion-list>
        <ion-item button (click)="goToProfileFromMenu()">
          <ion-label>Ir al Perfil</ion-label>
        </ion-item>
        <ion-item button (click)="logout()">
          <ion-label>Cerrar Sesión</ion-label>
        </ion-item>
      </ion-list>
    </ion-content>
  </ng-template>
</ion-popover>


<ion-content *ngIf="teacher && ratings; else loadingTemplate">
  <ion-card class="profile-card">
    <ion-card-content>
      <div class="profile-container">
        <!-- Foto + info en un div separado -->
        <div class="profile-left">
          <img 
            [src]="teacher?.profilepicture || 'assets/default-profile.png'" 
            alt="Foto del profesor" 
            class="profile-photo"
          />

          <div class="profile-info">
            <h2>{{ teacher?.name }}</h2>
            <p class="institution">{{ teacher?.institution }}</p>
          </div>
        </div>

        <!-- Botón Calificar + menú 3 puntos -->
        <div style="display: flex; align-items: center; gap: 8px;">
          <ion-button color="secondary" (click)="goToReview()">
            <ion-icon name="heart-outline" slot="start"></ion-icon>
            Calificar
          </ion-button>

          <!-- Botón menú profesor (3 puntos) -->
          <ion-button 
            *ngIf="isAdmin()" 
            fill="clear" 
            color="secondary" 
            (click)="openTeacherMenu($event)"
          >
            <ion-icon name="ellipsis-horizontal"></ion-icon>
          </ion-button>
        </div>
      </div>

      <!-- Descripción o contenido del profesor -->
      <p class="teacher-content">{{ teacher?.content }}</p>
    </ion-card-content>
  </ion-card>

  <ion-card  class="rating-card">
    <ion-card-content>
      <div class="rating-container">
        
        <!-- Calidad de la enseñanza -->
        <div class="rating-item">
          <div class="rating-header">
            <p class="rating-title">Calidad de la enseñanza</p>
            <span class="rating-value">{{ ratings?.teaching | number:'1.1-1' }} / 7</span>
          </div>
          <div class="rating-bar">
            <div class="rating-fill blue" [style.width.%]="(ratings?.teaching / 7) * 100"></div>
          </div>
        </div>

        <!-- Trato con el estudiante -->
        <div class="rating-item">
          <div class="rating-header">
            <p class="rating-title">Trato con el estudiante</p>
            <span class="rating-value">{{ ratings?.student | number:'1.1-1' }} / 7</span>
          </div>
          <div class="rating-bar">
            <div class="rating-fill yellow" [style.width.%]="(ratings?.student / 7) * 100"></div>
          </div>
        </div>

        <!-- Dificultad de la asignatura -->
        <div class="rating-item">
          <div class="rating-header">
            <p class="rating-title">Dificultad de la asignatura</p>
            <span class="rating-value">{{ ratings?.difficulty | number:'1.1-1' }} / 7</span>
          </div>
          <div class="rating-bar">
            <div class="rating-fill green" [style.width.%]="(ratings?.difficulty / 7) * 100"></div>
          </div>
        </div>

      </div>
    </ion-card-content>
  </ion-card>

<!-- RESEÑAS DE ESTUDIANTES -->
<ion-card  class="comments-card">
  <ion-card-content>
    <h3 class="comments-title">Reseñas de estudiantes</h3>

    <!-- Reseñas iterativas -->
    <div class="comment-item" *ngFor="let review of reviews">
      <div class="comment-header">
        <span class="comment-rating" >Calificación: {{ review.rating ? (review.rating | number:'1.1-1') : 'N/A' }}</span>

        <div class="comment-user-right">
          <div class="user-info">
            <span class="student-name">{{ review.username }}</span>
            <span class="comment-date">{{ review.date | date:'dd/MM/yyyy' }}</span>
          </div>
          <ion-avatar class="author-avatar">
            <img *ngIf="review.profilepicture; else defaultPic"
                [src]="'data:image/jpeg;base64,' + review.profilepicture" />
            <ng-template #defaultPic>
              <img src="assets/default-profile.png" />
            </ng-template>
          </ion-avatar>
        </div>
      </div>

      <p class="comment-content">{{ review.content }}</p>

      <!-- dentro del *ngFor="let review of reviews" -->
      <div class="comment-footer">
        <ion-button fill="clear" size="small" (click)="onReviewVote(review, 'like')">
          <ion-icon name="thumbs-up-outline" color="secondary"></ion-icon>
          <span>{{ review.likes }}</span>
        </ion-button>

        <ion-button fill="clear" size="small" (click)="onReviewVote(review, 'dislike')">
          <ion-icon name="thumbs-down-outline" color="secondary"></ion-icon>
          <span>{{ review.dislikes }}</span>
        </ion-button>

        <!-- Botón de menú (3 puntos horizontales) -->
        <ion-button
          *ngIf="canModify(review)"
          fill="clear"
          size="small"
          color="secondary"
          (click)="openReviewPopover($event, review)"
        >
          <ion-icon name="ellipsis-horizontal"></ion-icon>
        </ion-button>
      </div>
    </div> <!-- FIN review-item -->
  </ion-card-content>
</ion-card>
</ion-content>

<ng-template #loadingTemplate>
  <ion-content color="light">
    <ion-spinner name="crescent" style="margin: 20px auto; display: block;"></ion-spinner>
  </ion-content>
</ng-template>

<!-- Popover contextual -->
<ion-popover
  [isOpen]="reviewPopoverOpen"
  [event]="reviewPopoverEvent"
  (didDismiss)="reviewPopoverOpen = false"
>
  <ng-template>
    <ion-list>
      <ion-item button (click)="deleteReview(selectedReview)">
        <ion-label color="danger">Eliminar reseña</ion-label>
      </ion-item>
    </ion-list>
  </ng-template>
</ion-popover>

<!-- Popover menú del profesor -->
<ion-popover
  [isOpen]="teacherPopoverOpen"
  [event]="teacherPopoverEvent"
  (didDismiss)="teacherPopoverOpen = false"
>
  <ng-template>
    <ion-list>
      <ion-item button (click)="deleteTeacher()">
        <ion-label color="danger">Eliminar profesor</ion-label>
      </ion-item>
    </ion-list>
  </ng-template>
</ion-popover>